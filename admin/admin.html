<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emily Foister Site Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
  <style>
    :root{--gap:14px;--radius:14px;--pad:16px;--shadow:0 6px 24px rgba(0,0,0,.08)}
    *{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:24px;background:#f6f7f9;color:#111}
    .wrap{max-width:1100px;margin:auto;display:grid;gap:var(--gap)}
    header{display:flex;gap:10px;align-items:center;justify-content:space-between}
    h1{font-size:22px;margin:0}
    .card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:var(--pad)}
    .grid{display:grid;gap:var(--gap)}
    .two{grid-template-columns:1fr 1fr}
    label{font-size:12px;color:#444;display:block;margin-bottom:6px}
    input,button,select,textarea{font:inherit;padding:10px;border:1px solid #dcdfe5;border-radius:10px;width:100%}
    button{cursor:pointer;border:0;background:#111;color:#fff}
    button.ghost{background:#f0f1f3;color:#111;border:1px solid #dcdfe5}
    .row{display:flex;gap:10px;align-items:center}
    .items{display:grid;gap:10px}
    .item{display:grid;grid-template-columns:80px 1fr auto;gap:10px;align-items:center;padding:8px;border:1px solid #eee;border-radius:12px}
    .item img{width:80px;height:80px;object-fit:cover;border-radius:10px;border:1px solid #eee}
    .muted{color:#666;font-size:12px}
    .danger{background:#b00020}
    .hidden{display:none}
    .editor{min-height:220px;border:1px solid #dcdfe5;border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="row">
        <span id="who" class="muted"></span>
        <button id="logout" class="ghost hidden">Log out</button>
      </div>
    </header>

    <section id="auth" class="card">
      <div class="grid">
        <div>
          <h3>Sign in</h3>
          <form id="auth-form" autocomplete="on">
          <label>Email<input
  id="email"
  type="email"
  placeholder="you@example.com"
  autocomplete="username"
/>
</label>
          <label>Password<input
  id="password"
  type="password"
  placeholder="••••••••"
  autocomplete="current-password"
/>
</label>
          <div class="row">
            <button id="signin">Sign in</button>
            <button id="magic" class="ghost">Send magic link</button>
          </form>
          </div>
          <p class="muted">Only approved emails can edit.</p>
        </div>
      </div>
    </section>

    <section id="app" class="hidden">
      <div class="grid two">
        <!-- Slides manager -->
        <div class="card">
          <h2>Slider images</h2>
          <form id="slide-form" class="grid">
            <input type="hidden" id="slide-id" />
            <label>Caption (alt)
              <input id="slide-alt" maxlength="240" required />
            </label>
            <label>Thumb shape
              <select id="slide-shape">
                <option value="square" selected>Square</option>
                <option value="portrait">Portrait</option>
                <option value="landscape">Landscape</option>
              </select>
            </label>
            <div class="grid two">
              <label>Full image (for lightbox)
                <input id="slide-full" type="file" accept="image/*" />
              </label>
              <label>Thumbnail (optional)
                <input id="slide-thumb" type="file" accept="image/*" />
              </label>
            </div>
            <div class="grid two">
              <label>Position
                <input id="slide-pos" type="number" step="1" min="0" value="0" />
              </label>
              <label>Published
                <select id="slide-pub"><option value="true" selected>Yes</option><option value="false">No</option></select>
              </label>
            </div>
            <div class="row">
              <button id="save-slide" type="submit">Save</button>
              <button id="reset-slide" type="button" class="ghost">Reset</button>
            </div>
          </form>
          <div class="items" id="slides"></div>
        </div>

        <!-- Accordion manager -->
        <div class="card">
          <h2>Accordion sections</h2>
          <form id="sec-form" class="grid">
            <input type="hidden" id="sec-id" />
            <label>Title<input id="sec-title" required /></label>
            <label>Content (rich text)</label>
            <div id="sec-body" class="editor"></div>
            <div class="grid two">
              <label>Position<input id="sec-pos" type="number" step="1" min="0" value="0" /></label>
              <label>Published
                <select id="sec-pub"><option value="true" selected>Yes</option><option value="false">No</option></select>
              </label>
            </div>
            <div class="row">
              <button id="save-sec" type="submit">Save</button>
              <button id="reset-sec" type="button" class="ghost">Reset</button>
            </div>
          </form>
          <div class="items" id="sections"></div>
        </div>
      </div>
    </section>
  </div>

<script>
/* ===============================
   CONFIG
================================ */
const SB_URL = "https://opkhgpybppengmntfkae.supabase.co";
const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9wa2hncHlicHBlbmdtbnRma2FlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTkxNzEsImV4cCI6MjA3MDU5NTE3MX0.iMafxgfUm96zP1gYzYlU0NycGGfVQR6yIId1yRZg_DY";

/* ===============================
   HARD FAIL GUARDS
================================ */
if (!window.supabase) {
  throw new Error("Supabase JS not loaded. CDN missing or failed.");
}

/* ===============================
   CLIENT (single source of truth)
================================ */
const sb = window.supabase.createClient(SB_URL, ANON_KEY);

/* ===============================
   HELPERS
================================ */
const el = (id) => document.getElementById(id);
const show = (id, yes) => el(id).classList.toggle("hidden", !yes);
const uid = () => Math.random().toString(36).slice(2) + Date.now();

/* ===============================
   AUTH
================================ */
async function signIn() {
  const email = el("email").value.trim();
  const password = el("password").value;

  if (!email || !password) {
    alert("Email + password required");
    return;
  }

  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  if (error) {
    alert(error.message);
    return;
  }

  afterAuth(data.user);
}

async function magicLink() {
  const email = el("email").value.trim();
  if (!email) {
    alert("Enter email");
    return;
  }

  const { error } = await sb.auth.signInWithOtp({
    email,
    options: { emailRedirectTo: window.location.href },
  });

  if (error) {
    alert(error.message);
    return;
  }

  alert("Magic link sent. Check your email.");
}

async function logout() {
  await sb.auth.signOut();
  location.reload();
}

function afterAuth(user) {
  el("who").textContent = user.email;
  show("auth", false);
  show("app", true);
  el("logout").classList.remove("hidden");

  initQuill();
  loadSlides();
  loadSections();
}

/* ===============================
   QUILL
================================ */
function initQuill() {
  if (window._quilled) return;
  if (!window.Quill) {
    setTimeout(initQuill, 80);
    return;
  }

  const BaseImage = Quill.import("formats/image");
  class ImageWithAttrs extends BaseImage {
    static formats(domNode) {
      const f = super.formats(domNode) || {};
      ["alt", "data-full", "class"].forEach((k) => {
        const v = domNode.getAttribute(k);
        if (v) f[k] = v;
      });
      return f;
    }
    format(name, value) {
      if (["alt", "data-full", "class"].includes(name)) {
        value
          ? this.domNode.setAttribute(name, value)
          : this.domNode.removeAttribute(name);
      } else {
        super.format(name, value);
      }
    }
  }
  Quill.register(ImageWithAttrs, true);

  ["color", "background"].forEach((name) => {
    ["class", "style"].forEach((type) => {
      const attr = Quill.import(`attributors/${type}/${name}`);
      if (attr) Quill.register(attr, false);
    });
  });

  window._quill = new Quill("#sec-body", {
    theme: "snow",
    modules: {
      toolbar: [
        ["bold", "italic", "underline"],
        [{ header: [4, false] }],
        [{ list: "ordered" }, { list: "bullet" }],
        ["link", "image"],
        ["clean"],
      ],
    },
  });

  window._quilled = true;
}

/* ===============================
   STORAGE
================================ */
async function uploadToBucket(file, prefix) {
  const path = `${prefix}/${new Date().toISOString().slice(0, 10)}/${uid()}-${file.name}`;
  const { error } = await sb.storage.from("images").upload(path, file, { upsert: false });
  if (error) throw error;
  return sb.storage.from("images").getPublicUrl(path).data.publicUrl;
}

/* ===============================
   SLIDES
================================ */
async function loadSlides() {
  const list = el("slides");
  list.innerHTML = "";

  const { data, error } = await sb
    .from("slides")
    .select("*")
    .order("position", { ascending: true });

  if (error) {
    alert(error.message);
    return;
  }

  data.forEach((s) => list.appendChild(renderSlideItem(s)));
}

function renderSlideItem(s) {
  const div = document.createElement("div");
  div.className = "item";

  const img = document.createElement("img");
  img.src = s.thumb_url || s.full_url;
  img.alt = s.alt || "";

  const meta = document.createElement("div");
  meta.innerHTML = `
    <div><strong>${s.alt || "—"}</strong></div>
    <div class="muted">pos ${s.position ?? 0} · ${s.published ? "published" : "draft"} · ${s.shape || "square"}</div>
  `;

  const actions = document.createElement("div");
  actions.className = "grid";

  const edit = document.createElement("button");
  edit.textContent = "Edit";
  edit.onclick = () => fillSlideForm(s);

  const del = document.createElement("button");
  del.textContent = "Delete";
  del.className = "danger";
  del.onclick = () => deleteSlide(s.id);

  actions.append(edit, del);
  div.append(img, meta, actions);
  return div;
}

async function deleteSlide(id) {
  if (!confirm("Delete this slide?")) return;
  const { error } = await sb.from("slides").delete().eq("id", id);
  if (error) alert(error.message);
  loadSlides();
}

/* ===============================
   SECTIONS
================================ */
async function loadSections() {
  const list = el("sections");
  list.innerHTML = "";

  const { data, error } = await sb
    .from("sections")
    .select("*")
    .order("position", { ascending: true });

  if (error) {
    alert(error.message);
    return;
  }

  data.forEach((s) => list.appendChild(renderSectionItem(s)));
}

function renderSectionItem(s) {
  const div = document.createElement("div");
  div.className = "item";

  const meta = document.createElement("div");
  meta.innerHTML = `
    <div><strong>${s.title || "—"}</strong></div>
    <div class="muted">pos ${s.position ?? 0} · ${s.published ? "published" : "draft"}</div>
  `;

  const actions = document.createElement("div");
  actions.className = "grid";

  const edit = document.createElement("button");
  edit.textContent = "Edit";
  edit.onclick = () => fillSectionForm(s);

  const del = document.createElement("button");
  del.textContent = "Delete";
  del.className = "danger";
  del.onclick = () => deleteSection(s.id);

  actions.append(edit, del);
  div.append(meta, actions);
  return div;
}

/* ===============================
   BOOTSTRAP
================================ */
window.addEventListener("DOMContentLoaded", async () => {
el("auth-form").addEventListener("submit", (e) => {
  e.preventDefault();
  signIn();
});
  el("magic").onclick = magicLink;
  el("logout").onclick = logout;

  const { data } = await sb.auth.getUser();
  if (data?.user) afterAuth(data.user);
});
</script>

</body>

</html>
