<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Site Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
  <style>
    :root{--gap:14px;--radius:14px;--pad:16px;--shadow:0 6px 24px rgba(0,0,0,.08)}
    *{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:24px;background:#f6f7f9;color:#111}
    .wrap{max-width:1100px;margin:auto;display:grid;gap:var(--gap)}
    header{display:flex;gap:10px;align-items:center;justify-content:space-between}
    h1{font-size:22px;margin:0}
    .card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:var(--pad)}
    .grid{display:grid;gap:var(--gap)}
    .two{grid-template-columns:1fr 1fr}
    label{font-size:12px;color:#444;display:block;margin-bottom:6px}
    input,button,select,textarea{font:inherit;padding:10px;border:1px solid #dcdfe5;border-radius:10px;width:100%}
    button{cursor:pointer;border:0;background:#111;color:#fff}
    button.ghost{background:#f0f1f3;color:#111;border:1px solid #dcdfe5}
    .row{display:flex;gap:10px;align-items:center}
    .items{display:grid;gap:10px}
    .item{display:grid;grid-template-columns:80px 1fr auto;gap:10px;align-items:center;padding:8px;border:1px solid #eee;border-radius:12px}
    .item img{width:80px;height:80px;object-fit:cover;border-radius:10px;border:1px solid #eee}
    .muted{color:#666;font-size:12px}
    .danger{background:#b00020}
    .hidden{display:none}
    .editor{min-height:220px;border:1px solid #dcdfe5;border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Simple CMS</h1>
      <div class="row">
        <span id="who" class="muted"></span>
        <button id="logout" class="ghost hidden">Log out</button>
      </div>
    </header>

    <section id="auth" class="card">
      <div class="grid">
        <div>
          <h3>Sign in</h3>
          <label>Email<input id="email" type="email" placeholder="you@example.com"/></label>
          <label>Password<input id="password" type="password" placeholder="••••••••"/></label>
          <div class="row">
            <button id="signin">Sign in</button>
            <button id="magic" class="ghost">Send magic link</button>
          </div>
          <p class="muted">Only approved emails can edit.</p>
        </div>
      </div>
    </section>

    <section id="app" class="hidden">
      <div class="grid two">
        <!-- Slides manager -->
        <div class="card">
          <h2>Slider images</h2>
          <form id="slide-form" class="grid">
            <input type="hidden" id="slide-id" />
            <label>Caption (alt)
              <input id="slide-alt" maxlength="240" required />
            </label>
            <label>Thumb shape
              <select id="slide-shape">
                <option value="square" selected>Square</option>
                <option value="portrait">Portrait</option>
                <option value="landscape">Landscape</option>
              </select>
            </label>
            <div class="grid two">
              <label>Full image (for lightbox)
                <input id="slide-full" type="file" accept="image/*" />
              </label>
              <label>Thumbnail (optional)
                <input id="slide-thumb" type="file" accept="image/*" />
              </label>
            </div>
            <div class="grid two">
              <label>Position
                <input id="slide-pos" type="number" step="1" min="0" value="0" />
              </label>
              <label>Published
                <select id="slide-pub"><option value="true" selected>Yes</option><option value="false">No</option></select>
              </label>
            </div>
            <div class="row">
              <button id="save-slide" type="submit">Save</button>
              <button id="reset-slide" type="button" class="ghost">Reset</button>
            </div>
          </form>
          <div class="items" id="slides"></div>
        </div>

        <!-- Accordion manager -->
        <div class="card">
          <h2>Accordion sections</h2>
          <form id="sec-form" class="grid">
            <input type="hidden" id="sec-id" />
            <label>Title<input id="sec-title" required /></label>
            <label>Content (rich text)</label>
            <div id="sec-body" class="editor"></div>
            <div class="grid two">
              <label>Position<input id="sec-pos" type="number" step="1" min="0" value="0" /></label>
              <label>Published
                <select id="sec-pub"><option value="true" selected>Yes</option><option value="false">No</option></select>
              </label>
            </div>
            <div class="row">
              <button id="save-sec" type="submit">Save</button>
              <button id="reset-sec" type="button" class="ghost">Reset</button>
            </div>
          </form>
          <div class="items" id="sections"></div>
        </div>
      </div>
    </section>
  </div>

<script>
let supabase; // client
// ===== Hardcode your Supabase project once (no inputs) =====
const SB_URL = "https://opkhgpybppengmntfkae.supabase.co"; 
const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9wa2hncHlicHBlbmdtbnRma2FlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTkxNzEsImV4cCI6MjA3MDU5NTE3MX0.iMafxgfUm96zP1gYzYlU0NycGGfVQR6yIId1yRZg_DY";   

function uid(){return Math.random().toString(36).slice(2)+Date.now()}
function el(id){return document.getElementById(id)}
function show(id, yes){el(id).classList.toggle('hidden', !yes)}

// Quill init
function initQuill(){
  if (window._quilled) return; // init once
  if (!window.Quill) { setTimeout(initQuill, 80); return; }

  // --- Quill image blot that preserves class, alt, and data-full ---
  const BaseImage = Quill.import('formats/image');
  class ImageWithAttrs extends BaseImage {
    static formats(domNode) {
      const formats = super.formats(domNode) || {};
      ['alt','data-full','class'].forEach((attr)=>{
        const v = domNode.getAttribute(attr);
        if (v) formats[attr] = v;
      });
      return formats;
    }
    format(name, value) {
      if (['alt','data-full','class'].includes(name)) {
        if (value) this.domNode.setAttribute(name, value); else this.domNode.removeAttribute(name);
      } else {
        super.format(name, value);
      }
    }
  }
  Quill.register(ImageWithAttrs, true);

  const toolbarOptions = [
    ['bold','italic','underline'],
    [{ header: [4, false] }], // dropdown with H4 and normal
    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
    ['link','image'],
    ['clean']
  ];
  window._quill = new Quill('#sec-body', {
    theme: 'snow',
    modules: { toolbar: toolbarOptions }
  });

  function uid(){ return Math.random().toString(36).slice(2)+Date.now(); }
  async function uploadToBucket(file, prefix){
    const path = `${prefix}/${new Date().toISOString().slice(0,10)}/${uid()}-${file.name}`;
    const { error } = await supabase.storage.from('images').upload(path, file, { upsert:false });
    if (error) throw error;
    const { data } = supabase.storage.from('images').getPublicUrl(path);
    return data.publicUrl;
  }

  // Intercept image button: upload THUMB then FULL, insert required markup
  window._quill.getModule('toolbar').addHandler('image', () => {
    const pickFile = (label) => new Promise((resolve) => {
      const input = document.createElement('input');
      input.type = 'file'; input.accept = 'image/*'; input.style.display = 'none';
      document.body.appendChild(input);
      alert(label); // Prompt the user clearly for which file to upload
      input.onchange = () => { resolve(input.files && input.files[0]); document.body.removeChild(input); };
      input.click();
    });

    (async () => {
      try {
        const thumbFile = await pickFile('Please choose the THUMBNAIL image');
        if (!thumbFile) return;
        const thumbUrl = await uploadToBucket(thumbFile, 'thumbs');

        const fullFile = await pickFile('Please choose the FULL-SIZE image (optional)');
        let fullUrl;
        if (fullFile) fullUrl = await uploadToBucket(fullFile, 'full');
        else fullUrl = thumbUrl; // fallback if only one provided

        const alt = prompt('Caption (alt):') || '';
        const imgHtml = `<img class="lightbox-trigger" alt="${alt.replace(/"/g,'&quot;')}" src="${thumbUrl}" data-full="${fullUrl}"/>`;
        const range = window._quill.getSelection(true) || { index: window._quill.getLength(), length: 0 };
        window._quill.clipboard.dangerouslyPasteHTML(range.index, imgHtml);
      } catch (err) {
        console.warn('Image insert failed:', err);
        alert('Upload failed: ' + (err.message || err));
      }
    })();
  });

  window._quilled = true;
}



async function bootstrapClient(){
  if (!window.supabase) return false;
  if (!supabase) supabase = window.supabase.createClient(SB_URL, ANON_KEY);
  return true;
}

async function signIn(){
  if(!await bootstrapClient()) return;
  const email = el('email').value.trim();
  const password = el('password').value;
  if(!email || !password){alert('Email + password required');return}
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if(error){ alert(error.message); return }
  afterAuth(data.user);
}

async function magicLink(){
  if(!await bootstrapClient()) return;
  const email = el('email').value.trim();
  if(!email){alert('Enter email');return}
  const { error } = await supabase.auth.signInWithOtp({ email, options:{ emailRedirectTo: window.location.href } });
  if(error){ alert(error.message); return }
  alert('Magic link sent. Check your email.');
}

function afterAuth(user){
  el('who').textContent = user?.email || '';
  show('auth', false);
  show('app', true);
  el('logout').classList.remove('hidden');
  initQuill();
  loadSlides();
  loadSections();
}

async function logout(){ await supabase?.auth.signOut(); location.reload() }

// ---------- Slides ----------
async function loadSlides(){
  const list = el('slides'); list.innerHTML = '';
  const { data, error } = await supabase.from('slides').select('*').order('position', { ascending: true });
  if(error){ alert(error.message); return }
  data.forEach(s=> list.appendChild(renderSlideItem(s)));
}

function renderSlideItem(s){
  const div = document.createElement('div'); div.className='item';
  const img = document.createElement('img'); img.src = s.thumb_url || s.full_url; img.alt = s.alt || '';
  const meta = document.createElement('div');
  meta.innerHTML = `<div><strong>${s.alt||'—'}</strong></div>
    <div class="muted">pos ${s.position ?? 0} · ${s.published? 'published':'draft'} · ${s.shape||'square'}</div>
    <div class="muted" style="word-break:break-all">full: ${s.full_url}</div>`;
  const actions = document.createElement('div'); actions.className='grid';
  const edit = document.createElement('button'); edit.textContent='Edit'; edit.onclick=()=> fillSlideForm(s);
  const del = document.createElement('button'); del.textContent='Delete'; del.className='danger'; del.onclick=()=> deleteSlide(s.id);
  actions.append(edit, del);
  div.append(img, meta, actions);
  return div;
}

function resetSlideForm(){ el('slide-id').value=''; el('slide-alt').value=''; el('slide-full').value=''; el('slide-thumb').value=''; el('slide-pos').value='0'; el('slide-pub').value='true'; el('slide-shape').value='square'; }
function fillSlideForm(s){ el('slide-id').value=s.id; el('slide-alt').value=s.alt||''; el('slide-pos').value=s.position||0; el('slide-pub').value= String(!!s.published); el('slide-shape').value=(s.shape||'square'); }

async function uploadIfFile(input){
  const f = input.files?.[0]; if(!f) return null;
  const path = `uploads/${new Date().toISOString().slice(0,10)}/${uid()}-${f.name}`;
  const { error } = await supabase.storage.from('images').upload(path, f, { upsert:false });
  if(error) throw error;
  const { data } = supabase.storage.from('images').getPublicUrl(path);
  return data.publicUrl;
}

async function saveSlide(e){
  e.preventDefault();
  const id = el('slide-id').value || null;
  const alt = el('slide-alt').value.trim();
  const shape = el('slide-shape').value || 'square';
  const published = el('slide-pub').value === 'true';
  const position = Number(el('slide-pos').value||0);
  try{
    const fullUrlNew = await uploadIfFile(el('slide-full'));
    const thumbUrlNew = await uploadIfFile(el('slide-thumb'));
    if(id){
      const { data:rows, error:err1 } = await supabase.from('slides').select('*').eq('id', id).single();
      if(err1) throw err1;
      const update = { alt, shape, published, position, full_url: fullUrlNew || rows.full_url, thumb_url: thumbUrlNew || rows.thumb_url };
      const { error } = await supabase.from('slides').update(update).eq('id', id);
      if(error) throw error;
    }else{
      const { error } = await supabase.from('slides').insert([{ alt, shape, published, position, full_url: fullUrlNew, thumb_url: thumbUrlNew || fullUrlNew }]);
      if(error) throw error;
    }
    resetSlideForm();
    loadSlides();
  }catch(err){ alert(err.message || err) }
}

async function deleteSlide(id){
  if(!confirm('Delete this slide?')) return;
  const { error } = await supabase.from('slides').delete().eq('id', id);
  if(error){ alert(error.message); return }
  loadSlides();
}

// ---------- Sections ----------
async function loadSections(){
  const list = el('sections'); list.innerHTML = '';
  const { data, error } = await supabase.from('sections').select('*').order('position', { ascending: true });
  if(error){ alert(error.message); return }
  data.forEach(s=> list.appendChild(renderSectionItem(s)));
}

function renderSectionItem(s){
  const div = document.createElement('div'); div.className='item';
  const ph = document.createElement('img'); ph.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22><rect width=%2280%22 height=%2280%22 fill=%22%23f3f4f6%22/><text x=%2240%22 y=%2248%22 text-anchor=%22middle%22 font-size=%2212%22 fill=%22%23666%22>Sec</text></svg>';
  const meta = document.createElement('div');
  meta.innerHTML = `<div><strong>${s.title||'—'}</strong></div>
    <div class="muted">pos ${s.position ?? 0} · ${s.published? 'published':'draft'}</div>`;
  const actions = document.createElement('div'); actions.className='grid';
  const edit = document.createElement('button'); edit.textContent='Edit'; edit.onclick=()=> fillSectionForm(s);
  const del = document.createElement('button'); del.textContent='Delete'; del.className='danger'; del.onclick=()=> deleteSection(s.id);
  actions.append(edit, del);
  div.append(ph, meta, actions);
  return div;
}

function resetSecForm(){ el('sec-id').value=''; el('sec-title').value=''; if (window._quill) window._quill.root.innerHTML=''; el('sec-pos').value='0'; el('sec-pub').value='true' }
function fillSectionForm(s){ el('sec-id').value=s.id; el('sec-title').value=s.title||''; if (window._quill) window._quill.root.innerHTML = s.content_html||''; el('sec-pos').value=s.position||0; el('sec-pub').value= String(!!s.published) }

async function saveSection(e){
  e.preventDefault();
  const id = el('sec-id').value || null;
  const title = el('sec-title').value.trim();
  const content_html = (window._quill ? window._quill.root.innerHTML : '');
  const position = Number(el('sec-pos').value||0);
  const published = el('sec-pub').value === 'true';
  try{
    if(id){
      const { error } = await supabase.from('sections').update({ title, content_html, position, published }).eq('id', id);
      if(error) throw error;
    }else{
      const { error } = await supabase.from('sections').insert([{ title, content_html, position, published }]);
      if(error) throw error;
    }
    resetSecForm();
    loadSections();
  }catch(err){ alert(err.message || err) }
}

// ---------- Events ----------
window.addEventListener('DOMContentLoaded', async () => {
  // Initialize supabase client up-front
  if (window.supabase) supabase = window.supabase.createClient(SB_URL, ANON_KEY);

  el('signin').onclick = signIn;
  el('magic').onclick = magicLink;
  el('logout').onclick = logout;
  el('reset-slide').onclick = resetSlideForm;
  el('reset-sec').onclick = resetSecForm;
  el('slide-form').addEventListener('submit', saveSlide);
  el('save-sec').onclick = saveSection;

  // Resume session if already logged in
  if (supabase) {
    const { data: { user } } = await supabase.auth.getUser();
    if (user) afterAuth(user);
  }
});
</script>
</body>
</html>
